name: Python Iter Performance Bench

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: readme-update-group
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  python-bench:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up PyPy 3.10
      uses: actions/setup-python@v5
      with:
        python-version: 'pypy-3.10'

    - name: Run PP Iter Benchmark
      run: |
        cd python
        python pp_iter.py > bench_output.md
        cat bench_output.md >> $GITHUB_STEP_SUMMARY

    - name: Update Root README.md
      shell: python
      run: |
        import os, sys, datetime, subprocess
        start_marker = "[//]: # (PYTHON_PP_ITER_BENCHMARK_START)"
        end_marker = "[//]: # (PYTHON_PP_ITER_BENCHMARK_END)"
        try:
            cpu_info = subprocess.check_output("grep -m 1 'model name' /proc/cpuinfo", shell=True).decode().split(":")[1].strip()
        except:
            cpu_info = "GitHub Actions Runner"
        now_utc = datetime.datetime.now(datetime.timezone.utc)
        now_beijing = now_utc + datetime.timedelta(hours=8)
        time_str = f"{now_utc.strftime('%a %b %d %H:%M:%S %Y')} UTC / {now_beijing.strftime('%a %b %d %H:%M:%S %Y')} (UTC+8)"
        with open("python/bench_output.md", "r", encoding="utf-8") as f: new_data = f.read().strip()
        with open("README.md", "r", encoding="utf-8") as f: readme = f.read()
        if start_marker in readme and end_marker in readme:
            prefix = readme.split(start_marker)[0].strip()
            suffix = readme.split(end_marker)[-1].strip()
            content = f"### üêç Position Pure Iterator Performance (PyPy)\n\n#### Last Automated Run: {time_str}\n**Environment: {cpu_info}**\n\n{new_data}"
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(f"{prefix}\n\n{start_marker}\n\n{content}\n\n{end_marker}\n\n{suffix}\n")

    - name: Commit and Push
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        for i in {1..5}; do
          if git diff --quiet --staged; then exit 0; fi
          git commit -m "docs: update python benchmarks [skip ci]"
          git pull --rebase origin main
          if git push; then exit 0; fi
          sleep 5
        done