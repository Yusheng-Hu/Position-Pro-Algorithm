name: Python Iter Performance Bench

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Queue workflows to avoid Git race conditions (Exit Code 128)
concurrency:
  group: global-readme-sync
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  python-bench:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up PyPy 3.10
      uses: actions/setup-python@v5
      with:
        python-version: 'pypy-3.10'

    - name: Run Benchmark and Build Report
      # We use a single Python block to ensure Environment and Table are linked correctly
      run: |
        cd python
        python pp_iter.py > raw_output.log
        
        python3 -c "
        import subprocess, datetime, os, re

        # 1. Capture Environment Info
        try:
            cpu = subprocess.check_output('grep -m 1 \"model name\" /proc/cpuinfo', shell=True).decode().split(':')[1].strip()
        except:
            cpu = 'GitHub Actions Runner'

        # 2. Capture Time
        now_utc = datetime.datetime.now(datetime.timezone.utc)
        now_bj = now_utc + datetime.timedelta(hours=8)
        time_str = f\"{now_utc.strftime('%a %b %d %H:%M:%S %Y')} UTC / {now_bj.strftime('%a %b %d %H:%M:%S %Y')} (UTC+8)\"

        # 3. Parse Raw Data and Build Table
        table_rows = []
        if os.path.exists('raw_output.log'):
            with open('raw_output.log', 'r') as f:
                for line in f:
                    # Clean the line and split by whitespace
                    parts = line.strip().split()
                    # Expecting: N, Total, Itertools, PP, Speedup
                    if len(parts) >= 5 and parts[0].isdigit():
                        # Clean up 's' or other units if present to keep table clean
                        row = [p.replace('s', '') for p in parts]
                        table_rows.append(f'| {row[0]} | {row[1]} | {row[2]}s | {row[3]}s | **{row[4]}x** |')

        # 4. Assemble Final Markdown Content
        report = []
        report.append(f'#### Last Automated Run: {time_str}')
        report.append(f'**Environment: {cpu}**\n')
        report.append('| N | Total Permutations | Itertools (s) | Position Pure (s) | Speed-up |')
        report.append('|---|---|---|---|---|')
        report.extend(table_rows)

        with open('bench_final.md', 'w', encoding='utf-8') as f:
            f.write('\n'.join(report))
        "
        cat bench_final.md >> $GITHUB_STEP_SUMMARY

    - name: Inject into README.md
      shell: python
      run: |
        import os, sys
        start_m = "[//]: # (PYTHON_PP_ITER_BENCHMARK_START)"
        end_m = "[//]: # (PYTHON_PP_ITER_BENCHMARK_END)"

        with open("python/bench_final.md", "r", encoding="utf-8") as f:
            new_content = f.read().strip()
        with open("README.md", "r", encoding="utf-8") as f:
            readme = f.read()

        if start_m in readme and end_m in readme:
            prefix = readme.split(start_m)[0]
            suffix = readme.split(end_m)[1]
            
            # Rebuild the README with fixed title and the new content block
            updated_readme = f"{prefix}{start_m}\n\n### üêç Position Pure Iterator Performance (PyPy)\n\n{new_content}\n\n{end_m}{suffix}"
            
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(updated_readme)
        else:
            print('Markers not found!')
            sys.exit(1)

    - name: Synchronized Git Push
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        for i in {1..5}; do
          git add README.md
          if git commit -m "docs: fix python benchmark formatting and environment info [skip ci]"; then
            git pull --rebase origin main
            if git push; then exit 0; fi
          else
            echo "Nothing to commit"
            exit 0
          fi
          sleep 5
        done
        exit 1
