name: Python Iter Performance Bench
on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: readme-sync-group
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  python-bench:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run PyPy Benchmark
        run: |
          cd python
          python3 pp_iter.py > bench_output.md

      - name: Update README via Python
        shell: python
        run: |
          import sys, datetime
          start, end = "[//]: # (PYTHON_PP_ITER_BENCHMARK_START)", "[//]: # (PYTHON_PP_ITER_BENCHMARK_END)"
          now_utc = datetime.datetime.now(datetime.timezone.utc)
          now_bj = now_utc + datetime.timedelta(hours=8)
          time_str = f"{now_utc.strftime('%a %b %d %H:%M:%S %Y')} UTC / {now_bj.strftime('%a %b %d %H:%M:%S %Y')} (UTC+8)"
          with open("python/bench_output.md") as f: data = f.read().strip()
          with open("README.md") as f: readme = f.read()
          if start in readme:
              header = f"### üêç Position Pure Iterator Performance (PyPy)\n\n#### Last Run: {time_str}\n"
              new_readme = readme.split(start)[0] + start + "\n\n" + header + data + "\n\n" + end + readme.split(end)[-1]
              with open("README.md", "w") as f: f.write(new_readme)

      - name: Synchronized Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          for i in {1..5}; do
            git add README.md
            git commit -m "docs: update python benchmarks [skip ci]" || break
            git pull --rebase origin main
            if git push; then exit 0; fi
            sleep 5
          done