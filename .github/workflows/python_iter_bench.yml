name: Python Iter Performance Bench
on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: global-readme-sync
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  python-bench:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run PyPy
        run: |
          cd python
          python3 pp_iter.py > bench_output.md

      - name: Update and Push
        shell: python
        run: |
          import os, datetime, subprocess
          # 1. Update README content
          start, end = "[//]: # (PYTHON_PP_ITER_BENCHMARK_START)", "[//]: # (PYTHON_PP_ITER_BENCHMARK_END)"
          now_utc = datetime.datetime.now(datetime.timezone.utc)
          now_bj = now_utc + datetime.timedelta(hours=8)
          time_str = f"{now_utc.strftime('%a %b %d %H:%M:%S %Y')} UTC / {now_bj.strftime('%a %b %d %H:%M:%S %Y')} (UTC+8)"
          with open("python/bench_output.md") as f: data = f.read().strip()
          with open("README.md") as f: readme = f.read()
          if start in readme:
              header = f"### üêç Position Pure Iterator Performance (PyPy)\n\n#### Last Run: {time_str}\n"
              new_readme = readme.split(start)[0] + start + "\n\n" + header + data + "\n\n" + end + readme.split(end)[-1]
              open("README.md", "w").write(new_readme)
          
          # 2. Synchronized Git Push using subprocess to handle retries and rebase
          import subprocess, time
          subprocess.run(["git", "config", "--global", "user.name", "github-actions[bot]"])
          subprocess.run(["git", "config", "--global", "user.email", "github-actions[bot]@users.noreply.github.com"])
          for i in range(5):
              subprocess.run(["git", "add", "README.md"])
              if subprocess.run(["git", "commit", "-m", "docs: sync python benchmarks [skip ci]"]).returncode != 0:
                  break # No changes to commit
              subprocess.run(["git", "pull", "--rebase", "origin", "main"])
              if subprocess.run(["git", "push"]).returncode == 0:
                  sys.exit(0)
              time.sleep(5)