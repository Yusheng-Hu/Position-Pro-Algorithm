name: Automated Benchmark & README Update

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    env:
      # Aggressive optimization flags per your requirement
      CXX_FLAGS: "-O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Compile Programs
      run: |
        cd FullPermutation
        g++ $CXX_FLAGS heap_perm.cpp -o heap_test -pthread
        g++ $CXX_FLAGS permpure_full.cpp -o pure_test -pthread

    - name: Run Benchmarks
      run: |
        cd FullPermutation
        # Generate the results table with clean Markdown syntax
        echo "#### Last Automated Run: $(date -u) (UTC)" > results.md
        echo "" >> results.md
        echo "| N | Heap Algorithm (s) | PP Algorithm (s) | Speedup (Heap/PP) |" >> results.md
        echo "|---|---|---|---|" >> results.md
        
        for n in 9 10
        do
          H_TIME=$(./heap_test $n | grep "EXECUTION_TIME:" | awk '{print $2}')
          P_TIME=$(./pure_test $n | grep "EXECUTION_TIME:" | awk '{print $2}')
          SPEEDUP=$(echo "scale=2; $H_TIME / $P_TIME" | bc)
          echo "| $n | $H_TIME | $P_TIME | ${SPEEDUP}x |" >> results.md
        done
        cat results.md >> $GITHUB_STEP_SUMMARY

    - name: Update README.md via Python (Absolute Formatting Fix)
      shell: python
      run: |
        import re
        import sys

        # Defining the unique markers
        start_m = "[//]: # (UNIQUE_PP_ALGO_BENCHMARK_DATA_SECTION_START_DO_NOT_REMOVE)"
        end_m = "[//]: # (UNIQUE_PP_ALGO_BENCHMARK_DATA_SECTION_END_DO_NOT_REMOVE)"

        # 1. Read the new table
        with open("FullPermutation/results.md", "r", encoding="utf-8") as f:
            table_data = f.read().strip()

        # 2. Read current README.md
        with open("README.md", "r", encoding="utf-8") as f:
            content = f.read()

        # 3. Use Regex to find the block between markers and replace it
        # This pattern finds everything between the markers including the markers themselves
        pattern = re.compile(re.escape(start_m) + r".*?" + re.escape(end_m), re.DOTALL)
        
        # We wrap the new table in markers and add TRIPLE newlines for maximum safety
        # This ensures it can NEVER stick to the code block above or text below
        replacement = f"{start_m}\n\n{table_data}\n\n{end_m}"

        if pattern.search(content):
            new_content = pattern.sub(replacement, content)
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(new_content)
            print("README.md updated and rendering fixed.")
        else:
            print("Error: Markers not found or already corrupted.")
            sys.exit(1)

    - name: Commit and Push
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git diff --quiet && git diff --staged --quiet || (git commit -m "docs: permanent fix for benchmark rendering [skip ci]" && git push)
