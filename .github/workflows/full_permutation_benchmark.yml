name: Automated Benchmark & README Update

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    env:
      # High-performance optimization flags
      CXX_FLAGS: "-O3 -ffast-math -march=native"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Compile programs
      run: |
        # Navigating to the FullPermutation directory
        cd FullPermutation
        g++ $CXX_FLAGS heap_perm.cpp -o heap_perm
        g++ $CXX_FLAGS permpure_full.cpp -o permpure_full

    - name: Run Benchmarks
      run: |
        cd FullPermutation
        # Create a temporary markdown table with UTC timestamp
        echo "#### Last Automated Run: $(date -u) (UTC)" > results.md
        echo "| N | Heap Algorithm (s) | PP Algorithm (s) | Speedup (Heap/PP) |" >> results.md
        echo "|---|---|---|---|" >> results.md
        
        # Testing for N = 9, 10 as requested
        for n in 9 10
        do
          echo "Processing N=$n..."
          # Execute and extract execution time from stdout
          H_TIME=$(./heap_perm $n | grep "EXECUTION_TIME:" | awk '{print $2}')
          P_TIME=$(./permpure_full $n | grep "EXECUTION_TIME:" | awk '{print $2}')
          
          # Calculate speedup using 'bc'
          SPEEDUP=$(echo "scale=2; $H_TIME / $P_TIME" | bc)
          
          echo "| $n | $H_TIME | $P_TIME | ${SPEEDUP}x |" >> results.md
        done
        
        # Sync results to GitHub Action Summary
        cat results.md >> $GITHUB_STEP_SUMMARY

    - name: Update README.md
      run: |
        # Use line numbers to split the file, which is more reliable than range matching
        START_LINE=$(grep -n "" README.md | cut -d: -f1)
        END_LINE=$(grep -n "" README.md | cut -d: -f1)

        if [ -z "$START_LINE" ] || [ -z "$END_LINE" ]; then
          echo "Error: Benchmark markers not found in README.md"
          exit 1
        fi

        # 1. Get header (up to the start marker)
        head -n "$START_LINE" README.md > header.tmp
        
        # 2. Get footer (from the end marker to the end of file)
        tail -n +"$END_LINE" README.md > footer.tmp
        
        # 3. Concatenate all parts
        cat header.tmp > README.md
        cat FullPermutation/results.md >> README.md
        cat footer.tmp >> README.md
        
        rm header.tmp footer.tmp

    - name: Commit and Push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        
        # Commit only if changes exist to prevent infinite loops
        # [skip ci] is used to prevent re-triggering the same workflow
        git diff --quiet && git diff --staged --quiet || (git commit -m "docs: automated benchmark update [skip ci]" && git push)
