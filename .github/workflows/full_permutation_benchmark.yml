name: Automated Benchmark & README Update

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Prevent race conditions by limiting concurrency to one run at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    env:
      # Aggressive optimization flags for C++ performance
      CXX_FLAGS: "-O3 -std=c++11 -march=native -flto -ffast-math -fomit-frame-pointer"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # [cite_start]Fetch full history to ensure rebase works correctly during push [cite: 2]
        fetch-depth: 0

    - name: Compile Programs
      run: |
        # Build the executables for comparison
        cd FullPermutation
        g++ $CXX_FLAGS heap_perm.cpp -o heap_test -pthread
        g++ $CXX_FLAGS permpure_full.cpp -o pure_test -pthread

    - name: Run Benchmarks
      run: |
        cd FullPermutation
        
        # 1. Capture system hardware info and dual timestamps
        CPU_MODEL=$(grep -m 1 "model name" /proc/cpuinfo | cut -d: -f2 | sed 's/^[ \t]*//')
        TIME_UTC=$(date -u +"%a %b %d %H:%M:%S %Y UTC")
        TIME_BJ=$(TZ=Asia/Shanghai date +"%a %b %d %H:%M:%S %Y (UTC+8)")
        
        # 2. Initialize results markdown table
        echo "#### Last Automated Run: $TIME_UTC / $TIME_BJ" > results.md
        echo "**Environment: $CPU_MODEL (GitHub Actions Runner)**" >> results.md
        echo "" >> results.md
        echo "| N | Heap Algorithm (s) | PP Algorithm (s) | Speedup (Heap/PP) |" >> results.md
        echo "|---|---|---|---|" >> results.md
        
        # [cite_start]3. Iterating from N=9 to N=14 [cite: 2]
        for n in 9 10 11 12
        do
          echo "Processing benchmark for N=$n..."
          H_TIME=$(./heap_test $n | grep "EXECUTION_TIME:" | awk '{print $2}')
          P_TIME=$(./pure_test $n | grep "EXECUTION_TIME:" | awk '{print $2}')
          
          # [cite_start]Avoid division by zero [cite: 2]
          if [ "$P_TIME" = "0" ] || [ "$P_TIME" = "0.000" ]; then
            SPEEDUP="N/A"
          else
            SPEEDUP=$(echo "scale=2; $H_TIME / $P_TIME" | bc)
          fi
          echo "| $n | $H_TIME | $P_TIME | ${SPEEDUP}x |" >> results.md
        done
        # [cite_start]Output results to GitHub Step Summary [cite: 2]
        cat results.md >> $GITHUB_STEP_SUMMARY

    - name: Update README.md via Python
      shell: python
      run: |
        import os
        import sys

        # [cite_start]Identify injection points in README.md [cite: 2]
        start_marker = "[//]: # (UNIQUE_PP_ALGO_BENCHMARK_DATA_SECTION_START_DO_NOT_REMOVE)"
        end_marker = "[//]: # (UNIQUE_PP_ALGO_BENCHMARK_DATA_SECTION_END_DO_NOT_REMOVE)"

        # [cite_start]Read generated benchmark data and target README [cite: 2]
        try:
            with open("FullPermutation/results.md", "r", encoding="utf-8") as f:
                new_table = f.read().strip()
            
            with open("README.md", "r", encoding="utf-8") as f:
                content = f.read()
        except FileNotFoundError as e:
            print(f"Error: {e}")
            sys.exit(1)

        if start_marker in content and end_marker in content:
            # [cite_start]Isolate existing content segments [cite: 2]
            prefix = content.split(start_marker)[0].strip()
            suffix = content.split(end_marker)[-1].strip()
            
            # Reconstruct README content (Fixed the f-string syntax error)
            updated_readme = f"{prefix}\n\n{start_marker}\n\n{new_table}\n\n{end_marker}\n\n{suffix}\n"
            
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(updated_readme)
            print("README.md updated.")
        else:
            print("Error: Markers not found.")
            sys.exit(1)

    - name: Commit and Push Changes
      run: |
        # [cite_start]Configure Git identity [cite: 2]
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add README.md
        
        # [cite_start]Only proceed if changes exist [cite: 2]
        if ! git diff --quiet --staged; then
          git commit -m "docs: auto-update full permutation benchmarks [skip ci]"
          
          # [cite_start]Retry loop for push conflicts [cite: 2]
          for i in {1..5}; do
            echo "Push attempt $i..."
            git pull --rebase origin main
            if git push; then
              echo "Push successful."
              exit 0
            fi
            sleep 5
          done
          exit 1
        else
          echo "No changes detected."
        fi

