name: PP Algorithm Parallel Benchmark & Auto-Update README

on:
  push:
    paths:
      - 'parallel/parallel_position_pure.cpp'
  workflow_dispatch:

jobs:
  benchmark:
    name: Dual-Core Performance Analysis
    runs-on: windows-latest
    permissions:
      contents: write # Required to push changes back to the repository

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Compiler Environment
        run: |
          echo "C:\msys64\mingw64\bin" >> $GITHUB_PATH

      - name: Compile PP Algorithm
        # Compiling with -O3 for high-performance permutation generation
        run: |
          g++ -O3 -march=native parallel/parallel_position_pure.cpp -o parallel/pp_parallel.exe

      - name: Run Benchmarks and Collect Data
        shell: bash
        run: |
          # 1. Prepare Metadata (Fixed WMIC error by using powershell)
          TIMESTAMP_UTC=$(date -u)
          TIMESTAMP_LST=$(date -d "+8 hours" "+%a %b %d %H:%M:%S %Y (UTC+8)")
          
          # Use powershell to get CPU model to avoid 'wmic not found' issue in bash
          CPU_MODEL=$(powershell -Command "(Get-CimInstance -ClassName Win32_Processor).Name")
          
          # 2. Start building the content for README report
          REPORT_FILE="benchmark_summary.txt"
          echo "**Last Run:** $TIMESTAMP_UTC / $TIMESTAMP_LST" > $REPORT_FILE
          echo "**Environment:** $CPU_MODEL (GitHub Actions Runner)" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "| N | Core ID | Execution Time | Throughput (G/s) | Total Count |" >> $REPORT_FILE
          echo "|---|---|---|---|---|" >> $REPORT_FILE
          
          # 3. Run benchmarks for N=10 to 14
          for n in 10 11 12 13 14
          do
            echo "Processing N=$n..."
            ./parallel/pp_parallel.exe $n > output_$n.txt
            
            # Extract data using multi-stage awk
            c0_time=$(grep "Core 0" output_$n.txt | awk -F'=' '{print $2}' | awk '{print $1}')
            c0_tp=$(grep "Core 0" output_$n.txt | awk -F'=' '{print $3}' | awk '{print $1}')
            c1_time=$(grep "Core 1" output_$n.txt | awk -F'=' '{print $2}' | awk '{print $1}')
            c1_tp=$(grep "Core 1" output_$n.txt | awk -F'=' '{print $3}' | awk '{print $1}')
            total_cnt=$(grep "TOTAL COUNT:" output_$n.txt | awk '{print $NF}')
            
            # Format row for Markdown table
            echo "| $n | Core 0 | ${c0_time} | ${c0_tp} | - |" >> $REPORT_FILE
            echo "| $n | Core 1 | ${c1_time} | ${c1_tp} | ${total_cnt} |" >> $REPORT_FILE
          done

          # 4. Export to GitHub Step Summary
          cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

      - name: Update README.md
        shell: bash
        run: |
          # Define markers used in README.md
          START_MARKER="[//]: # (DUAL_CORE_BENCHMARK_START)"
          END_MARKER="[//]: # (DUAL_CORE_BENCHMARK_END)"
          
          # Execute Python script to safely replace content between markers
          python -c "
          import sys
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              with open('benchmark_summary.txt', 'r', encoding='utf-8') as f:
                  summary = f.read()
              
              start_tag = '$START_MARKER'
              end_tag = '$END_MARKER'
              
              if start_tag in content and end_tag in content:
                  parts = content.split(start_tag)
                  post_content = parts[1].split(end_tag)[1]
                  new_content = parts[0] + start_tag + '\n\n' + summary + '\n' + end_tag + post_content
                  
                  with open('README.md', 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print('README.md updated successfully.')
              else:
                  print('Error: Markers not found in README.md')
                  sys.exit(1)
          except Exception as e:
              print(f'Error during update: {e}')
              sys.exit(1)
          "

      - name: Commit and Push Changes
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          # [skip ci] prevents infinite loop of workflow triggers
          git commit -m "docs: auto-update parallel benchmark results [skip ci]" || echo "No changes to commit"
          git push
