# GitHub Actions workflow to benchmark the Position Pure (PP) Algorithm
name: PP Algorithm Parallel Benchmark

on:
  push:
    paths:
      - 'parallel/parallel_position_pure.cpp'
  workflow_dispatch:

jobs:
  benchmark:
    name: Dual-Core Performance Test
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Environment
        run: |
          echo "C:\msys64\mingw64\bin" >> $GITHUB_PATH

      - name: Compile Source Code
        run: |
          g++ -O3 -march=native parallel/parallel_position_pure.cpp -o parallel/pp_parallel.exe

      - name: Execute Benchmarks (N=10 to 13)
        shell: bash
        run: |
          # Initialize the Markdown table
          echo "### Performance Report: Position Pure (PP) Algorithm" >> $GITHUB_STEP_SUMMARY
          echo "| N | Core ID | Execution Time | Throughput (G/s) | Total Permutations |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|---|---|" >> $GITHUB_STEP_SUMMARY
          
          for n in 10 11 12 13
          do
            echo "Processing N=$n..."
            ./parallel/pp_parallel.exe $n > output_$n.txt
            
            # Robust extraction using sed:
            # Matches the number between 'Time = ' and 's'
            c0_time=$(grep "Core 0" output_$n.txt | sed -n 's/.*Time = \([0-9.]*\)s.*/\1/p')
            # Matches the number between 'Throughput = ' and ' G/s'
            c0_tp=$(grep "Core 0" output_$n.txt | sed -n 's/.*Throughput = \([0-9.]*\) G\/s.*/\1/p')
            
            c1_time=$(grep "Core 1" output_$n.txt | sed -n 's/.*Time = \([0-9.]*\)s.*/\1/p')
            c1_tp=$(grep "Core 1" output_$n.txt | sed -n 's/.*Throughput = \([0-9.]*\) G\/s.*/\1/p')
            
            total_cnt=$(grep "TOTAL COUNT:" output_$n.txt | awk '{print $NF}')
            
            # Write results to summary
            echo "| $n | Core 0 | ${c0_time}s | ${c0_tp} | - |" >> $GITHUB_STEP_SUMMARY
            echo "| $n | Core 1 | ${c1_time}s | ${c1_tp} | ${total_cnt} |" >> $GITHUB_STEP_SUMMARY
          done
